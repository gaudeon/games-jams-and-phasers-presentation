"use strict";const GAME_WIDTH=800,GAME_HEIGHT=600;let game=new Phaser.Game(GAME_WIDTH,GAME_HEIGHT);game.device.whenReady(function(){this.__plugins=this.__plugins||{},this.global={},this.state.add("Loading",LoadingState),this.state.add("Menu",MenuState),this.state.add("Level",LevelState),this.state.add("Results",ResultsState),this.state.start("Loading")},game);class Algorithm{constructor(t,e,i,s,h=Date.now()){this.game=t,this.width=e,this.height=i,this.grid=s,this.seed=h,this.rng=new Phaser.RandomDataGenerator([h])}run(t){}}class Cell{constructor(t,e,i,s=Math.random()){this.game=t,this.x=e,this.y=i,this.id=s,this._item=void 0,this.walls={north:!0,south:!0,east:!0,west:!0},this.adjacent_cells={right:null,left:null,down:null,up:null}}set cellRight(t){this.adjacent_cells.right=t}set cellLeft(t){this.adjacent_cells.left=t}set cellDown(t){this.adjacent_cells.down=t}set cellUp(t){this.adjacent_cells.up=t}get cellRight(){return this.adjacent_cells.right}get cellLeft(){return this.adjacent_cells.left}get cellDown(){return this.adjacent_cells.down}get cellUp(){return this.adjacent_cells.up}set wallNorth(t){this.walls.north=t,this.adjacent_cells.up&&(this.adjacent_cells.up.walls.south=t)}set wallSouth(t){this.walls.south=t,this.adjacent_cells.down&&(this.adjacent_cells.down.walls.north=t)}set wallEast(t){this.walls.east=t,this.adjacent_cells.right&&(this.adjacent_cells.right.walls.west=t)}set wallWest(t){this.walls.west=t,this.adjacent_cells.left&&(this.adjacent_cells.left.walls.east=t)}get wallNorth(){return this.walls.north}get wallSouth(){return this.walls.south}get wallEast(){return this.walls.east}get wallWest(){return this.walls.west}set item(t){this._item=t}get item(){return this._item}get hasItem(){return"undefined"!=typeof this._item}}class Grid{constructor(t,e=10,i=10){this.game=t,this.width=e,this.height=i,this.size=this.width*this.height,this.grid=[];for(let s=0;s<this.size;s++){let e=s%this.width,i=Math.floor(s/this.width);this.grid[s]=new Cell(t,e,i,s)}for(let s=0;s<this.size;s++){let t=s%this.width,e=Math.floor(s/this.width),i=this.getCell(t,e);t<this.width-1&&(i.cellRight=this.getCell(t+1,e)),t>0&&(i.cellLeft=this.getCell(t-1,e)),e<this.height-1&&(i.cellDown=this.getCell(t,e+1)),e>0&&(i.cellUp=this.getCell(t,e-1))}}getCell(t,e){let i=e*this.width+t;return this.grid[i]}}class Maze extends Phaser.SpriteBatch{constructor(game,grid_x=0,grid_y=0,grid_width=10,grid_height=10,algorithm="Solid",seed=Date.now(),debug=false){super(game),this.grid_width=grid_width,this.grid_height=grid_height,this.grid_x=grid_x,this.grid_y=grid_y,this.line_size=4,this.cell_size=100,this.grid=new Grid(game,this.grid_width,this.grid_height),this.debug=debug,this.seed=seed,this.algorithm=algorithm,this.algorithm_class=eval(`${algorithm}Algorithm`),"undefined"==typeof this.algorithm_class&&(this.algorithm="Solid",this.algorithm_class=SolidAlgorithm),this.wall_color=13619151,this.h_wall_graphic=new Phaser.Graphics(this.game),this.h_wall_graphic.beginFill(this.wall_color),this.h_wall_graphic.drawRect(0,0,this.cell_size,this.line_size),this.h_wall_graphic.endFill(),this.h_wall_texture=this.h_wall_graphic.generateTexture(),this.v_wall_graphic=new Phaser.Graphics(this.game),this.v_wall_graphic.beginFill(this.wall_color),this.v_wall_graphic.drawRect(0,0,this.line_size,this.cell_size),this.v_wall_graphic.endFill(),this.v_wall_texture=this.v_wall_graphic.generateTexture(),this.algorithm_obj=new this.algorithm_class(game,grid_width,grid_height,this.grid,this.seed),this.algorithm_obj.run(),this.enableBody=!0,this.physicsBodyType=Phaser.Physics.P2JS,this.draw()}pixelWidth(){return this.grid_width*this.cell_size+this.grid_width*this.line_size+this.line_size}pixelHeight(){return this.grid_height*this.cell_size+this.grid_height*this.line_size+this.line_size}cellCenterValue(t){return t*this.cell_size+this.cell_size/2-t*this.line_size}cellTopLeftX(t){return this.grid_x+this.cell_size*t-this.line_size*t}cellTopLeftY(t){return this.grid_y+this.cell_size*t-this.line_size*t}cellCenterX(t){return this.cellTopLeftX(t)+this.cell_size/2}cellCenterY(t){return this.cellTopLeftY(t)+this.cell_size/2}cellSetItem(t,e,i){this.grid.getCell(t,e).item=i}cellGetItem(t,e){this.grid.getCell(t,e).item}cellHasItem(t,e){this.grid.getCell(t,e).hasItem}adjacentCellHasItem(t,e){let i=this.grid.getCell(t,e);return i.cellUp&&i.cellUp.hasItem||i.cellRight&&i.cellRight.hasItem||i.cellDown&&i.cellDown.hasItem||i.cellLeft&&i.cellLeft.hasItem}draw(){for(let t=0;t<this.grid_width;t++)for(let e=0;e<this.grid_height;e++){let i=this.grid.getCell(t,e),s=this.cellTopLeftX(t),h=this.cellTopLeftY(e),a=function(i){return`${i}_wall_${t}_${e}`},n=[];i.wallNorth&&!i.cellUp&&n.push({x:s+this.cell_size/2,y:h+this.line_size/2,texture:this.h_wall_texture,name:a("north")}),i.wallEast&&n.push({x:s+this.cell_size-this.line_size/2,y:h+this.cell_size/2,texture:this.v_wall_texture,name:a("east")}),i.wallSouth&&n.push({x:s+this.cell_size/2,y:h+this.cell_size-this.line_size/2,texture:this.h_wall_texture,name:a("south")}),i.wallWest&&!i.cellLeft&&n.push({x:s+this.line_size/2,y:h+this.cell_size/2,texture:this.v_wall_texture,name:a("east")}),n.forEach(t=>{this.add(new Wall(this.game,t.x,t.y,t.texture,t.name,this.debug))})}}}class Wall extends Phaser.Sprite{constructor(t,e,i,s,h="wall",a=false){super(t,e,i,s),this.game.physics.p2.enable(this),this.debug=a,this.anchor.x=.5,this.anchor.y=.5,this.name=h,this.body.static=!0,this.body.debug=this.debug}}class Cheese extends Phaser.Sprite{constructor(t,e,i,s,h=false){let a=s&&s.match(/^(speed|bomb)$/)?s:void 0,n=a?`cheese_${a}`:"cheese";super(t,e,i,"spriteAtlas",n),this.cheese_type=a,this.debug=h,this.width=48,this.height=32,this.anchor.x=.5,this.anchor.y=.5,this.name="cheese",this.game.physics.p2.enable(this),this.body.static=!0,this.body.debug=this.debug}applyEffect(t){switch(this.cheese_type){case"speed":t.rat.speed=t.rat.enhanced_speed,t.cheese_speed_enabled=!0,t.cheese_speed_time_remaining+=7;break;case"bomb":t.startCheeseBomb();break;default:t.time_remaining+=10,t.cleanupOneCheeseBomb()}}}class Rat extends Phaser.Sprite{constructor(t,e,i,s=false){super(t,e,i,"spriteAtlas","rat"),this.debug=s,this.width=27,this.height=64,this.anchor.x=.5,this.anchor.y=.5,this.name="rat",this.cheese_collected=0,this.normal_speed=150,this.enhanced_speed=300,this.speed=this.normal_speed;let h=new Phaser.RandomDataGenerator([Date.now()]),a=h.between(159,255),n=h.between(159,255),l=h.between(159,255);this.normal_color=a<<16|n<<8|l,this.tint=this.normal_color,this.bombs=[],this.bomb_color=7274496,this.color_switch_delta_time=0,this.game.physics.p2.enable(this),this.body.angularDamping=1,this.body.collideWorldBounds=!0,this.body.onBeginContact.add(t=>{t&&(t.sprite.name.match(/wall/)?this.body.setZeroVelocity():"cheese"==t.sprite.name&&t.sprite.kill())}),this.body.onEndContact.add(t=>{t&&t.sprite&&t.sprite.name&&t.sprite.name.match(/wall/)&&this.body.setZeroVelocity()}),this.controls=this.game.input.keyboard.createCursorKeys(),this.game.camera.follow(this,Phaser.Camera.FOLLOW_LOCKON,.1,.1),this.body.debug=this.debug}update(){let t=!1;this.controls.left.isDown?(this.body.moveLeft(this.speed),t=!0):this.controls.right.isDown&&(this.body.moveRight(this.speed),t=!0),this.controls.up.isDown?(this.body.moveUp(this.speed),t=!0):this.controls.down.isDown&&(this.body.moveDown(this.speed),t=!0),t?this.body.angle=Phaser.Math.radToDeg(Math.atan2(this.body.velocity.y,this.body.velocity.x))+90:this.body.setZeroVelocity(),this.bombs.length>0?this.color_switch_delta_time>=250?(this.tint==this.normal_color?this.tint=this.bomb_color:this.tint=this.normal_color,this.color_switch_delta_time=0):this.color_switch_delta_time+=this.game.time.elapsed:this.tint=this.normal_color}}class LevelState extends Phaser.State{constructor(t){super(t)}init(t=1,e=10,i=5,s={}){this.statistics=s,this.statistics.level_seed=this.statistics.level_seed||Date.now(),this.statistics.levels=this.statistics.levels||{},this.level_number=t,this.rng=new Phaser.RandomDataGenerator([this.statistics.level_seed]),this.base_maze_size=e,this.maze_size=this.base_maze_size+(this.level_number>1?2:0),this.base_num_cheese=i,this.num_cheese=this.base_num_cheese+(this.level_number>1?1:0),this.time_remaining=15,this.time_elapsed=0,this.padding=100,this.debug=!1,this.cheese_speed_time_remaining=0,this.cheese_speed_enabled=!1}create(){this.game.physics.startSystem(Phaser.Physics.P2JS),this.game.time.desiredFPS=30,this.game.stage.backgroundColor="#6f6f6f",this.maze=new Maze(this.game,this.padding,this.padding,this.maze_size,this.maze_size,"BinaryTree",this.level_seed,this.debug);let t=this.maze.pixelWidth()+this.padding;t=t<this.game.width?this.game.width:t;let e=this.maze.pixelHeight()+this.padding;e=e<this.game.height?this.game.height:e,this.game.world.setBounds(0,0,t,e);let i=this.rng.between(0,this.maze_size-1),s=this.rng.between(0,this.maze_size-1);this.rat=new Rat(this.game,this.maze.cellCenterX(i),this.maze.cellCenterY(s),this.debug),this.game.add.existing(this.rat),this.maze.cellSetItem(i,s,this.rat),this.cheese=[];let h={speed:{allowed:Math.ceil((this.num_cheese-5)/2),used:0},bomb:{allowed:Math.ceil((this.num_cheese-6)/3),used:0}};for(let a=0;a<this.num_cheese;a++){let t=this.rng.between(0,this.maze_size-1),e=this.rng.between(0,this.maze_size-1),i=0;for(;(this.maze.cellHasItem(t,e)||this.maze.adjacentCellHasItem(t,e))&&++i<=this.maze_size;)t=this.rng.between(0,this.maze_size-1),e=this.rng.between(0,this.maze_size-1);let s=void 0;h.speed.used<h.speed.allowed&&(s="speed",h.speed.used++),h.bomb.used<h.bomb.allowed&&(s="bomb",h.bomb.used++),this.cheese_sound=this.game.add.audio("cheeseSound",1,!1),this.bomb_sound=this.game.add.audio("bombSound",1,!1);let a=new Cheese(this.game,this.maze.cellCenterX(t),this.maze.cellCenterY(e),s,this.debug);a.events.onKilled.add(t=>{this.cheese_sound.play(),this.rat.cheese_collected++,t.applyEffect(this)}),this.game.add.existing(a),this.maze.cellSetItem(t,e,a),this.cheese.push(a)}this.hud=new Hud(this.game,this,this.debug),this.startTimers()}update(){this.rat.cheese_collected>=this.num_cheese&&this.levelSuccess()}recordStatistics(t){this.statistics.levels[this.level_number]={completed:!1,num_cheese:this.num_cheese,cheese_collected:this.rat.cheese_collected,time_elapsed:this.time_elapsed}}startTimers(){this.game_over_timer=this.game.time.create(!1),this.game_over_timer.loop(1e3,()=>{this.time_remaining--,this.time_elapsed++,this.time_remaining<=0&&this.levelFailed()}),this.game_over_timer.start(),this.cheese_speed_timer=this.game.time.create(!1),this.cheese_speed_timer.loop(1e3,()=>{this.cheese_speed_enabled&&--this.cheese_speed_time_remaining<=0&&(this.rat.speed=this.rat.normal_speed,this.cheese_speed_enabled=!1,this.cheese_speed_time_remaining=0)}),this.cheese_speed_timer.start()}cleanupTimers(){this.rat.bombs.forEach(t=>{t.destroy()}),this.game_over_timer.destroy(),this.cheese_speed_timer.destroy()}startCheeseBomb(){let t=this.game.time.create(!0);t.add(1e4,()=>{this.bomb_sound.play(),this.levelFailed()}),t.start(),this.rat.bombs.push(t)}cleanupOneCheeseBomb(){if(this.rat.bombs.length>0){let t=this.rat.bombs.splice(0,1);t.forEach(t=>{t.destroy()})}}levelFailed(){this.cleanupTimers(),this.recordStatistics(!1),this.state.start("Results",!0,!1,this.statistics)}levelSuccess(){this.cleanupTimers(),this.recordStatistics(!0),this.state.start("Level",!0,!1,this.level_number+1,this.maze_size,this.num_cheese,this.statistics)}}class LoadingState extends Phaser.State{constructor(t){super(t)}preload(){this.load.json("menuConfig","./assets/json/menu.json"),this.game.load.atlas("spriteAtlas","./assets/images/sprites.png","./assets/json/sprites.json",Phaser.Loader.TEXTURE_ATLAS_JSON_HASH),this.game.load.audio("cheeseSound","./assets/sounds/cheese.wav"),this.game.load.audio("bombSound","./assets/sounds/bomb.wav")}update(){window.webfonts_are_loaded&&this.state.start("Menu")}}class MenuState extends Phaser.State{constructor(t){super(t)}init(){this.config=this.game.cache.getJSON("menuConfig")}create(){this.game.world.setBounds(0,0,800,600),this.game.stage.backgroundColor="#3f3f3f";let t=0;this.config.items.forEach(e=>{let i=this.add.text(0,t,e.label,this.config.style);if(i.setTextBounds(0,0,this.world.width,this.world.height),e.state){i.addColor(this.config.link.color,0);let t=e.state;i.inputEnabled=!0,i.events.onInputUp.add(e=>{this.state.start(t,!0,!1)})}else i.addColor(this.config.label.color,0);t+=this.config.style.fontSize+10}),this.controls=this.game.input.keyboard.createCursorKeys(),this.controls.enter=this.game.input.keyboard.addKey(Phaser.KeyCode.ENTER)}update(){this.controls.enter.isDown&&this.state.start("Level",!0,!1)}}class ResultsState extends Phaser.State{constructor(t){super(t)}init(t){this.statistics=t||{level_seed:Date.now(),levels:{}},this.debug=!1,this.time_remaining=60}create(){this.results_display=new ResultsDisplay(this.game,this,this.debug),this.results_display.y=this.game.height,this.results_display.visible=!0,this.timer=this.game.time.create(!1),this.timer.loop(1e3,()=>{this.time_remaining--,this.time_remaining<=0&&this.next()}),this.timer.start()}update(){this.results_display.y>0&&(this.results_display.y-=30)}next(){this.timer.destroy(),this.state.start("Menu",!0,!1)}}class CheeseCounter extends Phaser.Text{constructor(t,e,i,s,h=false){super(t,e,i,"",{font:"32px Chewy",fontSize:32,fill:"#ff6666"}),this.state=s,this.debug=h}update(){let t=this.state.rat.cheese_collected,e=this.state.num_cheese;this.text=`${t} / ${e}`}}class CountDown extends Phaser.Text{constructor(t,e,i,s="#ff6666",h,a=false){super(t,e,i,"",{font:"32px Chewy",fontSize:32,fill:s}),this.color=s,this.state=h,this.debug=a}update(){let t=Math.floor(this.state.time_remaining/60),e=this.state.time_remaining-60*t;e=e<10?"0"+e:e,this.text=`${t}:${e}`}}class Hud extends Phaser.Group{constructor(t,e,i=false){super(t),this.state=e,this.debug=i,this.fixedToCamera=!0,this.bar_height=50,this.bar_color=4144959,this.bar_graphic=new Phaser.Graphics(this.game),this.bar_graphic.beginFill(this.bar_color),this.bar_graphic.drawRect(0,0,this.game.width,this.bar_height),this.bar_graphic.endFill(),this.bar_texture=this.bar_graphic.generateTexture(),this.bar=this.create(0,this.game.height-this.bar_height,this.bar_texture),this.cheese_icon=this.create(10,this.game.height-this.bar_height+15,"spriteAtlas","cheese"),this.cheese_icon.width=32,this.cheese_icon.height=21,this.cheese_counter=this.add(new CheeseCounter(this.game,72,this.game.height-this.bar_height+8,this.state,this.debug)),this.watch_icon=this.create(this.game.width-120,this.game.height-this.bar_height+16,"spriteAtlas","stopwatch"),this.watch_icon.width=24,this.watch_icon.height=24,this.countdown=this.add(new CountDown(this.game,this.game.width-70,this.game.height-this.bar_height+8,"#ff6666",this.state,this.debug))}}class ResultsDisplay extends Phaser.Group{constructor(t,e,i=false){super(t),this.state=e,this.debug=i,this.bg_color=4144959,this.bg_graphic=new Phaser.Graphics(this.game),this.bg_graphic.beginFill(this.bg_color),this.bg_graphic.drawRect(0,0,this.game.width,this.game.height),this.bg_graphic.endFill(),this.bg_texture=this.bg_graphic.generateTexture(),this.bg=this.create(0,0,this.bg_texture),this.stats_top=120,this.stats=this.statistics(),this.stats.x=(this.game.width-this.stats.width)/2,this.stats.y=this.stats_top,this.bg_color=7303023,this.bg_graphic=new Phaser.Graphics(this.game),this.bg_graphic.beginFill(this.bg_color),this.bg_graphic.drawRect(0,0,this.game.width,100),this.bg_graphic.endFill(),this.bg_texture=this.bg_graphic.generateTexture(),this.bg=this.create(0,0,this.bg_texture);let s=10;this.title=new Phaser.Text(this.game,0,s,"Ahh Rats! Game Over",{font:"48px Chewy",fontSize:48,fill:"#ffffff",boundsAlignH:"center"}),this.title.setTextBounds(0,s,this.game.width,this.title.height),this.add(this.title),this.bg_color=7303023,this.bg_graphic=new Phaser.Graphics(this.game),this.bg_graphic.beginFill(this.bg_color),this.bg_graphic.drawRect(0,0,this.game.width,100),this.bg_graphic.endFill(),this.bg_texture=this.bg_graphic.generateTexture(),this.bg=this.create(0,this.game.height-100,this.bg_texture),this.countdown=new CountDown(this.game,this.game.width-70,this.game.height-66,"#efefef",this.state,this.debug),this.add(this.countdown),this.prompt_text=new Phaser.Text(this.game,10,this.game.height-62,"Use arrow keys to scroll. Press [enter] to continue...",{font:"28px Chewy",fontSize:28,fill:"#efefef"}),this.add(this.prompt_text),this.controls=this.game.input.keyboard.createCursorKeys(),this.controls.enter=this.game.input.keyboard.addKey(Phaser.KeyCode.ENTER),this.visible=!1}update(){this.controls.up.isDown&&this.stats.y<this.stats_top?this.stats.y+=10:this.controls.down.isDown&&this.stats.y>this.stats_top-this.stats.height+this.game.height-220&&(this.stats.y-=10),this.controls.enter.isDown&&this.state.next(),this.countdown.update()}arrow(){let t=new Phaser.Sprite(this.game,0,0,"spriteAtlas","arrow");return t.width=35,t.height=30,t.tint=16737894,t.anchor.x=.5,t.anchor.y=.5,t}statistics(){let t=new Phaser.Group(this.game,this);for(let e in this.state.statistics.levels){let i=this.state.statistics.levels[e],s=58*(e-1),h=new Phaser.Text(this.game,0,s,`${e}.`,{font:"48px Chewy",fontSize:48,fill:"#ff6666"});t.add(h);let a=t.create(100,s+18,"spriteAtlas","cheese");a.width=32,a.height=21;let n=i.cheese_collected||0,l=i.num_cheese||0,r=new Phaser.Text(this.game,150,s+12,`${n} / ${l}`,{font:"32px Chewy",fontSize:32,fill:"#ff6666"});t.add(r);let o=t.create(300,s+16,"spriteAtlas","stopwatch");o.width=24,o.height=24;let c=i.time_elapsed||0,d=Math.floor(c/60),g=c-60*d;g=g<10?"0"+g:g;let _=new Phaser.Text(this.game,345,s+12,`${d}:${g}`,{font:"32px Chewy",fontSize:32,fill:"#ff6666"});t.add(_)}return t}}class BinaryTreeAlgorithm extends Algorithm{constructor(t,e,i,s,h){super(t,e,i,s,h)}run(){for(var t=0;t<this.width;t++)for(var e=0;e<this.height;e++){var i=this.grid.getCell(t,e);t<this.width-1&&e<this.height-1?i.wallEast&&i.wallSouth&&(this.rng.integer()%2==0?i.wallEast=!1:i.wallSouth=!1):t==this.width-1&&e<this.height-1?i.wallSouth=!1:t<this.width-1&&e==this.height-1&&(i.wallEast=!1)}}}class SolidAlgorithm extends Algorithm{constructor(t,e,i,s,h){super(t,e,i,s,h)}run(){}}